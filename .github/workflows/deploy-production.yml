name: Deploy to Production (Manual)

# This workflow is MANUAL ONLY - it must be triggered manually after testing in staging
# Use this after you've verified your changes in the staging environment

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy-to-production" to confirm'
        required: true
        type: string

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  validate-input:
    name: Validate Confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy-to-production" ]; then
            echo "‚ùå Confirmation failed. You must type 'deploy-to-production' exactly."
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

  deploy-production:
    name: Deploy to Railway Production
    runs-on: ubuntu-latest
    needs: validate-input
    environment:
      name: production
      url: https://${{ secrets.RAILWAY_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pre-deployment info
        run: |
          echo "‚ö†Ô∏è  DEPLOYING TO PRODUCTION ‚ö†Ô∏è"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "Make sure you've tested this in staging first!"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Auth with Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway whoami

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to Railway PRODUCTION environment..."

          # Switch to production environment
          railway project switch --id "$RAILWAY_PROJECT_ID" || {
            echo "‚ö†Ô∏è Failed to switch project"
          }
          railway environment switch --name production || {
            echo "‚ùå Failed to switch to production environment"
            exit 1
          }

          # Trigger deployment
          railway up --detach || {
            echo "‚ùå Production deployment failed"
            exit 1
          }

          echo "‚úÖ Production deployment triggered"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for production deployment to complete..."
          sleep 60
          railway logs --follow --tail 50 || true

      - name: Verify production deployment
        run: |
          echo "üîç Verifying production deployment..."
          max_attempts=15
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            DOMAIN="${{ secrets.RAILWAY_DOMAIN }}"
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health || echo "000")

            if [ "$HEALTH_STATUS" == "200" ]; then
              echo "‚úÖ Production deployment healthy!"
              echo "Service responding at: https://$DOMAIN"
              exit 0
            fi

            echo "Attempt $attempt/$max_attempts: Health check returned $HEALTH_STATUS"
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "‚ùå Production health check failed after $max_attempts attempts"
          exit 1

  verify-production:
    name: Verify Production
    runs-on: ubuntu-latest
    needs: deploy-production

    steps:
      - name: Wait for stabilization
        run: sleep 30

      - name: Run smoke tests
        env:
          API_BASE_URL: ${{ secrets.RAILWAY_DOMAIN }}
        run: |
          echo "üß™ Running production smoke tests..."

          # Health check
          echo "Testing /health endpoint..."
          curl -f https://$API_BASE_URL/health || {
            echo "‚ùå Health check failed"
            exit 1
          }
          echo "‚úÖ Health check passed"

          # Model catalog check
          echo "Testing /v1/models endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://$API_BASE_URL/v1/models)
          if [ "$response" = "200" ]; then
            echo "‚úÖ Model catalog responding"
          else
            echo "‚ö†Ô∏è Model catalog returned: $response"
          fi

          # Ping check
          echo "Testing /ping endpoint..."
          curl -f https://$API_BASE_URL/ping || true

          echo ""
          echo "‚úÖ Production smoke tests complete"

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production, verify-production]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## üöÄ Production Deployment Summary

          ### Status
          - **Deploy**: ${{ needs.deploy-production.result }}
          - **Verify**: ${{ needs.verify-production.result }}

          ### Details
          - **Triggered by**: ${{ github.actor }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Time**: $(date -u)

          ### Production URL
          https://${{ secrets.RAILWAY_DOMAIN }}

          ### Next Steps
          - Monitor production logs
          - Check Sentry for errors
          - Verify key endpoints are responding
          EOF

          if [ "${{ needs.deploy-production.result }}" = "success" ] && [ "${{ needs.verify-production.result }}" = "success" ]; then
            echo "üéâ Production deployment successful!"
          else
            echo "‚ùå Production deployment failed!"
            echo "Check logs and consider rolling back if necessary"
          fi
