name: Monitor Deployment Health

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Every hour (reduced from every 15 minutes)

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  monitor-health:
    name: Check Deployment Health
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Check production health
        id: prod-health
        continue-on-error: true
        run: |
          echo "Checking production deployment..."

          DOMAIN="${{ secrets.RAILWAY_DOMAIN }}"
          MAX_ATTEMPTS=3
          ATTEMPT=1

          # Retry logic for health check
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 https://$DOMAIN/health || echo "error\n000")

            HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -1)
            BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" == "200" ]; then
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              echo "‚úÖ Production deployment is healthy"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Retrying in 5 seconds..."
              sleep 5
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Production deployment unhealthy after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Get deployment logs
        if: steps.prod-health.outcome == 'failure'
        run: |
          echo "Fetching recent deployment logs..."
          railway project switch --id $RAILWAY_PROJECT_ID
          railway environment switch --name production
          railway logs --tail 100 || true

      - name: Create issue if health check fails (with deduplication)
        if: steps.prod-health.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Production Deployment Health Check Failed';
            const body = `
            ## Deployment Health Check Alert

            **Status**: UNHEALTHY

            **Environment**: Production

            **Time**: ${new Date().toISOString()}

            **Check**: Health endpoint at https://${{ secrets.RAILWAY_DOMAIN }}/health returned non-200 status

            ### Actions
            - [ ] Check Railway dashboard for errors
            - [ ] Review recent logs
            - [ ] Trigger manual redeploy if needed
            - [ ] Investigate root cause

            **Next Steps**:
            1. View [Railway Dashboard](https://railway.app)
            2. Check container logs
            3. Verify database connectivity
            4. Check environment variables

            [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            // Check if issue already exists (and is recent - within last 6 hours)
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['deployment-alert']
            });

            const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);
            const existingIssue = issues.find(issue =>
              issue.title.includes('Production Deployment Health Check Failed') &&
              new Date(issue.created_at) > sixHoursAgo
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['deployment-alert', 'urgent']
              });
              console.log('‚úÖ Created health check failure issue');
            } else {
              console.log('‚ÑπÔ∏è Health check failure issue already exists (created within last 6 hours)');
            }

      - name: Check staging health
        id: staging-health
        continue-on-error: true
        run: |
          echo "Checking staging deployment..."

          # Staging domain - derive from production domain if available
          if [ ! -z "${{ secrets.STAGING_DOMAIN }}" ]; then
            STAGING_DOMAIN="${{ secrets.STAGING_DOMAIN }}"
          else
            # Fallback: assume staging-<domain> pattern
            STAGING_DOMAIN="staging-${{ secrets.RAILWAY_DOMAIN }}"
          fi

          MAX_ATTEMPTS=3
          ATTEMPT=1

          # Retry logic for health check
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 https://$STAGING_DOMAIN/health || echo "error\n000")

            HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -1)

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" == "200" ]; then
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              echo "‚úÖ Staging deployment is healthy"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Retrying in 5 seconds..."
              sleep 5
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Staging deployment unhealthy after $MAX_ATTEMPTS attempts"
          exit 1

  # Collect metrics
  collect-metrics:
    name: Collect Deployment Metrics
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Collect production metrics
        continue-on-error: true
        run: |
          railway project switch --id $RAILWAY_PROJECT_ID
          railway environment switch --name production

          echo "üìä Production Metrics"
          echo "=================="
          railway metrics || echo "Metrics not available via CLI"

          # Alternative: Get container info
          railway service list || true

      - name: Generate deployment report
        run: |
          echo "## Deployment Health Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Generated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Environment Status" >> deployment-report.md
          echo "- Production: ${{ needs.monitor-health.outputs.prod_health_status || 'unknown' }}" >> deployment-report.md
          echo "- Staging: ${{ needs.monitor-health.outputs.staging_health_status || 'unknown' }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Quick Links" >> deployment-report.md
          echo "- [Railway Dashboard](https://railway.app)" >> deployment-report.md
          echo "- [Production Domain](https://${{ secrets.RAILWAY_DOMAIN }})" >> deployment-report.md
          echo "- [Health Check](https://${{ secrets.RAILWAY_DOMAIN }}/health)" >> deployment-report.md

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 7
