name: Deploy to Railway Test Environment

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "requirements.txt"
      - "pyproject.toml"
      - "railway.json"
      - "start.sh"
      - ".github/workflows/deploy.yml"

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  # Setup: Always deploy to staging on main push
  setup-environment:
    name: Setup Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: staging
      railway_environment: staging

    steps:
      - name: Deployment Info
        run: |
          echo "üöÄ Deploying to STAGING environment"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

  # Pull all CI checks before deploying
  check-ci-status:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    needs: setup-environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for CI workflow
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            console.log(`Checking CI status for commit ${sha}...`);

            // Poll for CI workflow completion (max 5 minutes)
            let attempts = 0;
            const maxAttempts = 30;

            while (attempts < maxAttempts) {
              const checkRuns = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha,
              });

              console.log(`Attempt ${attempts + 1}: Found ${checkRuns.data.check_runs.length} check runs`);

              // Get the CI workflow
              const ciWorkflows = checkRuns.data.check_runs.filter(run =>
                run.name === 'Code Quality Checks' ||
                run.name === 'Security Scan' ||
                run.name === 'Run Tests (Shard 1)' ||
                run.name === 'Run Tests (Shard 2)' ||
                run.name === 'Run Tests (Shard 3)' ||
                run.name === 'Run Tests (Shard 4)' ||
                run.name === 'Coverage Report' ||
                run.name === 'Build Verification' ||
                run.name === 'Deployment Ready'
              );

              if (ciWorkflows.length === 0) {
                console.log('Waiting for CI checks to start...');
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 10000));
                continue;
              }

              const allCompleted = ciWorkflows.every(run =>
                run.status === 'completed'
              );

              if (!allCompleted) {
                console.log('Waiting for CI checks to complete...');
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 10000));
                continue;
              }

              const allPassed = ciWorkflows.every(run =>
                run.conclusion === 'success'
              );

              if (!allPassed) {
                const failedChecks = ciWorkflows
                  .filter(run => run.conclusion !== 'success')
                  .map(run => `${run.name} (${run.conclusion})`)
                  .join(', ');
                core.setFailed(`CI checks failed: ${failedChecks}`);
                process.exit(1);
              }

              console.log('‚úÖ All CI checks passed!');
              break;
            }

            if (attempts >= maxAttempts) {
              core.setFailed('CI checks did not complete within 5 minutes');
              process.exit(1);
            }

  # Deploy to Railway Staging
  deploy-railway:
    name: Deploy to Railway Staging (Test Environment)
    runs-on: ubuntu-latest
    needs: [setup-environment, check-ci-status]
    environment:
      name: staging
      url: https://${{ secrets.RAILWAY_STAGING_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Auth with Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway whoami

      - name: Deploy to Railway Staging
        run: |
          echo "üöÄ Deploying to Railway STAGING environment..."

          # Set Railway project and environment
          railway project switch --id "$RAILWAY_PROJECT_ID" || {
            echo "‚ö†Ô∏è Failed to switch project, attempting deployment anyway..."
          }
          railway environment switch --name staging || {
            echo "‚ö†Ô∏è Failed to switch environment, attempting deployment anyway..."
          }

          # Trigger deployment
          railway up --detach || {
            echo "‚ùå Deployment trigger failed"
            exit 1
          }

          echo "‚úÖ Deployment triggered"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for Railway deployment to complete..."
          sleep 60
          railway logs --follow --tail 50 || true

      - name: Verify staging deployment
        run: |
          echo "üîç Verifying staging deployment..."
          max_attempts=12
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            DOMAIN="${{ secrets.RAILWAY_STAGING_DOMAIN }}"
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health || echo "000")

            if [ "$HEALTH_STATUS" == "200" ]; then
              echo "‚úÖ Staging deployment healthy! Service responding at https://$DOMAIN"
              echo ""
              echo "üß™ Test your changes at: https://$DOMAIN"
              echo "üìù When ready, deploy to production manually from Railway dashboard"
              exit 0
            fi

            echo "Attempt $attempt/$max_attempts: Health check returned $HEALTH_STATUS"
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "‚ö†Ô∏è Deployment verification incomplete, but deployment was triggered"
          exit 0

  # Notify deployment status
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [setup-environment, deploy-railway]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on related PR
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            // Find PR that was just merged
            for (const pr of pullRequests) {
              if (pr.merged_at && new Date(pr.merged_at) > new Date(Date.now() - 60000)) {
                const domain = '${{ secrets.RAILWAY_STAGING_DOMAIN }}';
                const deployStatus = '${{ needs.deploy-railway.result }}';

                let message = '';
                if (deployStatus === 'success') {
                  message = `üöÄ **Deployed to Staging (Test Environment)**\n\n` +
                    `Environment: **staging**\n` +
                    `Test at: https://${domain}\n` +
                    `Commit: ${context.sha.substring(0, 7)}\n` +
                    `Branch: ${context.ref_name}\n\n` +
                    `üß™ Test your changes, then deploy to production manually from Railway dashboard.`;
                } else {
                  message = `‚ö†Ô∏è **Staging Deployment Failed**\n\n` +
                    `Status: ${deployStatus}\n` +
                    `Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: message
                });
                break;
              }
            }

      - name: Deployment summary
        run: |
          DOMAIN="${{ secrets.RAILWAY_STAGING_DOMAIN }}"
          STATUS="${{ needs.deploy-railway.result }}"

          echo "=== Staging Deployment Summary ==="
          echo "Environment: staging (test)"
          echo "Test URL: https://$DOMAIN"
          echo "Status: $STATUS"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          if [ "$STATUS" == "success" ]; then
            echo "‚úÖ Staging deployment completed successfully!"
            echo ""
            echo "Next steps:"
            echo "1. Test your changes at: https://$DOMAIN"
            echo "2. When ready, deploy to production:"
            echo "   - Via Railway Dashboard: https://railway.app/"
            echo "   - Or via CLI: railway up --environment production"
          else
            echo "‚ö†Ô∏è Staging deployment had issues. Check the logs above."
          fi

      - name: Trigger monitoring workflow
        if: needs.deploy-railway.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'monitor-deployment.yml',
                ref: context.ref,
              });
              console.log('‚úÖ Monitoring workflow triggered');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not trigger monitoring workflow:', error.message);
            }
