name: Deploy to Railway Test Environment

on:
<<<<<<< HEAD
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "requirements.txt"
      - "pyproject.toml"
      - "railway.json"
      - "start.sh"
      - ".github/workflows/deploy.yml"
=======
  # Trigger after CI Pipeline completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, staging]
  # Manual trigger for explicit deployments
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - production
          - staging
>>>>>>> refs/remotes/origin/main

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  # Setup: Always deploy to staging on main push
  setup-environment:
    name: Setup Deployment Environment
    runs-on: blacksmith-4vcpu-ubuntu-2404
    # Only run if CI passed (for workflow_run) or manual dispatch
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      environment: staging
      railway_environment: staging

    steps:
      - name: Deployment Info
        run: |
<<<<<<< HEAD
          echo "üöÄ Deploying to STAGING environment"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
=======
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            case "$ENV" in
              production)
                RAILWAY_ENV="production"
                echo "environment=production" >> $GITHUB_OUTPUT
                echo "railway_environment=production" >> $GITHUB_OUTPUT
                ;;
              staging)
                RAILWAY_ENV="staging"
                echo "environment=staging" >> $GITHUB_OUTPUT
                echo "railway_environment=staging" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            # Auto-detect from workflow_run branch
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            if [ "$BRANCH" == "main" ]; then
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "railway_environment=production" >> $GITHUB_OUTPUT
            elif [ "$BRANCH" == "staging" ]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "railway_environment=staging" >> $GITHUB_OUTPUT
            else
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "railway_environment=staging" >> $GITHUB_OUTPUT
            fi
          fi
>>>>>>> refs/remotes/origin/main

      - name: Log CI completion
        if: github.event_name == 'workflow_run'
        run: |
          echo "‚úÖ CI Pipeline completed successfully"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "Proceeding with deployment..."

  # Deploy to Railway Staging
  deploy-railway:
<<<<<<< HEAD
    name: Deploy to Railway Staging (Test Environment)
    runs-on: ubuntu-latest
    needs: [setup-environment, check-ci-status]
=======
    name: Deploy to Railway (${{ needs.setup-environment.outputs.environment }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [setup-environment]
>>>>>>> refs/remotes/origin/main
    environment:
      name: staging
      url: https://${{ secrets.RAILWAY_STAGING_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use the SHA from the workflow_run event, or current SHA for manual dispatch
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli

      - name: Auth with Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway whoami

      - name: Deploy to Railway Staging
        run: |
          echo "üöÄ Deploying to Railway STAGING environment..."

          # Set Railway project and environment
          railway project switch --id "$RAILWAY_PROJECT_ID" || {
            echo "‚ö†Ô∏è Failed to switch project, attempting deployment anyway..."
          }
          railway environment switch --name staging || {
            echo "‚ö†Ô∏è Failed to switch environment, attempting deployment anyway..."
          }

          # Trigger deployment
          railway up --detach || {
            echo "‚ùå Deployment trigger failed"
            exit 1
          }

          echo "‚úÖ Deployment triggered"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for Railway deployment to complete..."
          sleep 60
          railway logs --follow --tail 50 || true

      - name: Verify staging deployment
        run: |
          echo "üîç Verifying staging deployment..."
          max_attempts=12
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            DOMAIN="${{ secrets.RAILWAY_STAGING_DOMAIN }}"
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health || echo "000")

            if [ "$HEALTH_STATUS" == "200" ]; then
              echo "‚úÖ Staging deployment healthy! Service responding at https://$DOMAIN"
              echo ""
              echo "üß™ Test your changes at: https://$DOMAIN"
              echo "üìù When ready, deploy to production manually from Railway dashboard"
              exit 0
            fi

            echo "Attempt $attempt/$max_attempts: Health check returned $HEALTH_STATUS"
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "‚ö†Ô∏è Deployment verification incomplete, but deployment was triggered"
          exit 0

  # Notify deployment status
  notify-deployment:
    name: Notify Deployment Status
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [setup-environment, deploy-railway]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on related PR
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            // Find PR that was just merged
            for (const pr of pullRequests) {
              if (pr.merged_at && new Date(pr.merged_at) > new Date(Date.now() - 60000)) {
                const domain = '${{ secrets.RAILWAY_STAGING_DOMAIN }}';
                const deployStatus = '${{ needs.deploy-railway.result }}';

                let message = '';
                if (deployStatus === 'success') {
                  message = `üöÄ **Deployed to Staging (Test Environment)**\n\n` +
                    `Environment: **staging**\n` +
                    `Test at: https://${domain}\n` +
                    `Commit: ${context.sha.substring(0, 7)}\n` +
                    `Branch: ${context.ref_name}\n\n` +
                    `üß™ Test your changes, then deploy to production manually from Railway dashboard.`;
                } else {
                  message = `‚ö†Ô∏è **Staging Deployment Failed**\n\n` +
                    `Status: ${deployStatus}\n` +
                    `Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: message
                });
                break;
              }
            }

      - name: Deployment summary
        run: |
          DOMAIN="${{ secrets.RAILWAY_STAGING_DOMAIN }}"
          STATUS="${{ needs.deploy-railway.result }}"

          echo "=== Staging Deployment Summary ==="
          echo "Environment: staging (test)"
          echo "Test URL: https://$DOMAIN"
          echo "Status: $STATUS"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          if [ "$STATUS" == "success" ]; then
            echo "‚úÖ Staging deployment completed successfully!"
            echo ""
            echo "Next steps:"
            echo "1. Test your changes at: https://$DOMAIN"
            echo "2. When ready, deploy to production:"
            echo "   - Via Railway Dashboard: https://railway.app/"
            echo "   - Or via CLI: railway up --environment production"
          else
            echo "‚ö†Ô∏è Staging deployment had issues. Check the logs above."
          fi

      - name: Trigger monitoring workflow
        if: needs.deploy-railway.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'monitor-deployment.yml',
                ref: context.ref,
              });
              console.log('‚úÖ Monitoring workflow triggered');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not trigger monitoring workflow:', error.message);
            }
