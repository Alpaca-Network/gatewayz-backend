name: Scheduled Model Sync

on:
  schedule:
    # Run every 6 hours at :00 (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'

    # Additional schedules (uncomment to use):
    # - cron: '0 2 * * *'        # Daily at 2 AM UTC
    # - cron: '0 2,14 * * *'     # Twice daily (2 AM and 2 PM UTC)
    # - cron: '0 */4 * * *'      # Every 4 hours
    # - cron: '0 0,6,12,18 * * *' # Four times daily

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (fetch but don''t write to database)'
        required: false
        default: false
        type: boolean

env:
  API_URL: ${{ secrets.API_URL || 'https://api.gatewayz.ai' }}
  ADMIN_KEY: ${{ secrets.ADMIN_KEY }}

jobs:
  sync-models:
    name: Sync Models
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests jq

      - name: Check API health
        id: health_check
        run: |
          echo "üîç Checking API health..."
          if curl -sf "$API_URL/health" > /dev/null; then
            echo "‚úÖ API is healthy"
            echo "api_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå API is not reachable at $API_URL"
            echo "api_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get pre-sync database count
        id: pre_sync
        if: steps.health_check.outputs.api_healthy == 'true'
        run: |
          echo "üìä Getting current database status..."
          STATUS=$(curl -s "$API_URL/admin/model-sync/status")
          PRE_COUNT=$(echo "$STATUS" | jq -r '.models.stats.total_active // 0')
          echo "pre_count=$PRE_COUNT" >> $GITHUB_OUTPUT
          echo "   Current database models: $PRE_COUNT"

      - name: Trigger full model sync
        id: model_sync
        if: steps.health_check.outputs.api_healthy == 'true'
        run: |
          echo "üîÑ Starting full model sync..."
          echo "   Endpoint: $API_URL/admin/model-sync/all"
          echo "   This may take 3-5 minutes..."
          echo ""

          START_TIME=$(date +%s)

          # Make request with verbose output
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/response.json -X POST "$API_URL/admin/model-sync/all")
          RESPONSE=$(cat /tmp/response.json)

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "üìä Request Details:"
          echo "   HTTP Status: $HTTP_CODE"
          echo "   Duration: ${DURATION}s"
          echo "   Response length: ${#RESPONSE} bytes"
          echo ""

          # Show raw response for debugging
          echo "üìÑ Raw Response (first 500 chars):"
          echo "$RESPONSE" | head -c 500
          echo ""
          echo ""

          # Check if response is valid JSON
          if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "‚ùå API returned invalid JSON"
            echo "Full response:"
            echo "$RESPONSE"
            echo ""
            echo "This usually means:"
            echo "  - API returned an error page (HTML)"
            echo "  - API is not responding correctly"
            echo "  - Endpoint does not exist"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "üìã Parsed JSON Response:"
          echo "$RESPONSE" | jq '.'
          echo ""

          # Check if successful
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            MODELS_SYNCED=$(echo "$RESPONSE" | jq -r '.details.total_models_synced // 0')
            PROVIDERS=$(echo "$RESPONSE" | jq -r '.details.providers_processed // 0')

            echo "‚úÖ Model sync completed successfully"
            echo "   Duration: ${DURATION}s"
            echo "   Providers: $PROVIDERS"
            echo "   Models synced: $MODELS_SYNCED"

            echo "success=true" >> $GITHUB_OUTPUT
            echo "models_synced=$MODELS_SYNCED" >> $GITHUB_OUTPUT
            echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
            echo "duration=$DURATION" >> $GITHUB_OUTPUT
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.message // "Unknown error"')
            echo "‚ùå Model sync failed: $ERROR"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get post-sync database count
        id: post_sync
        if: always() && steps.health_check.outputs.api_healthy == 'true'
        run: |
          echo "üìä Getting post-sync database status..."
          sleep 3  # Wait for database to update

          STATUS=$(curl -s "$API_URL/admin/model-sync/status")
          POST_COUNT=$(echo "$STATUS" | jq -r '.models.stats.total_active // 0')
          echo "post_count=$POST_COUNT" >> $GITHUB_OUTPUT

          PRE_COUNT="${{ steps.pre_sync.outputs.pre_count }}"
          ADDED=$((POST_COUNT - PRE_COUNT))

          echo "   Database models: $POST_COUNT"
          echo "   Models added: $ADDED"

          if [ "$POST_COUNT" -ge 17000 ]; then
            echo "‚úÖ Database is fully synced"
            echo "sync_status=healthy" >> $GITHUB_OUTPUT
          elif [ "$POST_COUNT" -ge 15000 ]; then
            echo "‚ö†Ô∏è  Database is mostly synced"
            echo "sync_status=warning" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Database needs attention"
            echo "sync_status=critical" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## üîÑ Scheduled Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**API URL**: $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.model_sync.outputs.success }}" = "true" ]; then
            echo "### ‚úÖ Model Sync" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Duration**: ${{ steps.model_sync.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
            echo "- **Providers**: ${{ steps.model_sync.outputs.providers }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Models Synced**: ${{ steps.model_sync.outputs.models_synced }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Model Sync" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Database Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Before**: ${{ steps.pre_sync.outputs.pre_count }} models" >> $GITHUB_STEP_SUMMARY
          echo "- **After**: ${{ steps.post_sync.outputs.post_count }} models" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.post_sync.outputs.sync_status }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Scheduled sync failed!"
          echo "Check workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Optional: Add Slack/Discord/Email notification here
          # Example for Slack:
          # curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{"text":"üö® Gatewayz sync failed! Check GitHub Actions."}'
