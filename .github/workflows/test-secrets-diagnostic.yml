name: Test Secrets Diagnostic

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/test-secrets-diagnostic.yml'

jobs:
  check-secrets:
    name: Verify Secrets Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if secrets are available
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        run: |
          echo "=== Secrets Availability Check ==="
          echo ""

          # Check SUPABASE_URL
          if [ -n "$SUPABASE_URL" ]; then
            echo "✅ SUPABASE_URL is available"
            echo "   Length: ${#SUPABASE_URL} characters"
            echo "   Starts with: ${SUPABASE_URL:0:20}..."

            # Validate format
            if [[ "$SUPABASE_URL" =~ ^https:// ]]; then
              echo "   ✅ URL format is valid (starts with https://)"
            else
              echo "   ❌ URL format is invalid (should start with https://)"
            fi
          else
            echo "❌ SUPABASE_URL is NOT available"
            echo "   Using fallback: 'https://test.supabase.co'"
          fi

          echo ""

          # Check SUPABASE_KEY
          if [ -n "$SUPABASE_KEY" ]; then
            echo "✅ SUPABASE_KEY is available"
            echo "   Length: ${#SUPABASE_KEY} characters"
            echo "   Starts with: ${SUPABASE_KEY:0:10}..."
          else
            echo "❌ SUPABASE_KEY is NOT available"
            echo "   Using fallback: 'test-key'"
          fi

          echo ""

          # Check CEREBRAS_API_KEY
          if [ -n "$CEREBRAS_API_KEY" ]; then
            echo "✅ CEREBRAS_API_KEY is available"
            echo "   Length: ${#CEREBRAS_API_KEY} characters"
          else
            echo "⚠️  CEREBRAS_API_KEY is NOT available (optional)"
          fi

          echo ""
          echo "=== Summary ==="

          SECRETS_OK=true

          if [ -z "$SUPABASE_URL" ]; then
            echo "❌ Missing SUPABASE_URL"
            SECRETS_OK=false
          fi

          if [ -z "$SUPABASE_KEY" ]; then
            echo "❌ Missing SUPABASE_KEY"
            SECRETS_OK=false
          fi

          if [ "$SECRETS_OK" = true ]; then
            echo "✅ All required secrets are configured correctly!"
            echo ""
            echo "Expected test results:"
            echo "  - Tests collected: ~2461"
            echo "  - Tests passing: ~2430"
            echo "  - Tests skipped: ~31"
          else
            echo "❌ Required secrets are missing!"
            echo ""
            echo "Current test results:"
            echo "  - Tests collected: ~1861"
            echo "  - Tests passing: ~1854"
            echo "  - Tests skipped: ~600"
            echo ""
            echo "To fix:"
            echo "1. Go to: Settings → Secrets and variables → Actions"
            echo "2. Add repository secrets:"
            echo "   - SUPABASE_URL (your Supabase project URL)"
            echo "   - SUPABASE_KEY (your Supabase service role key)"
          fi

          echo ""
          echo "=== Workflow Context ==="
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Base ref: ${{ github.base_ref }}"

          # Check if this is a fork PR
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo ""
            echo "⚠️  WARNING: This is a PR from a FORK!"
            echo "   Fork: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "   Base: ${{ github.repository }}"
            echo ""
            echo "   Secrets are NOT available for fork PRs (GitHub security policy)"
            echo "   This is EXPECTED behavior - tests will skip database tests"
          fi

      - name: Test database connection (if secrets available)
        if: env.SUPABASE_URL != '' && env.SUPABASE_KEY != ''
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=== Testing Supabase Connection ==="

          # Install minimal dependencies
          pip install --quiet requests python-dotenv

          # Test connection with a simple HTTP request
          python3 << 'PYEOF'
          import os
          import requests

          url = os.getenv('SUPABASE_URL')
          key = os.getenv('SUPABASE_KEY')

          print(f"Testing connection to: {url[:30]}...")

          try:
              # Try to access the REST API
              response = requests.get(
                  f"{url}/rest/v1/",
                  headers={
                      "apikey": key,
                      "Authorization": f"Bearer {key}"
                  },
                  timeout=10
              )

              if response.status_code == 200:
                  print("✅ Successfully connected to Supabase!")
                  print(f"   Status: {response.status_code}")
              elif response.status_code == 404:
                  print("✅ Supabase is reachable (404 is expected for root endpoint)")
              else:
                  print(f"⚠️  Supabase responded with status: {response.status_code}")
                  print(f"   Response: {response.text[:200]}")
          except Exception as e:
              print(f"❌ Connection failed: {e}")
              print("   This may indicate invalid credentials or network issues")
          PYEOF
