name: Supabase Migrations

on:
  push:
    branches:
      - main
      - staging
    paths:
      - "supabase/migrations/*.sql"
      - ".github/workflows/supabase-migrations.yml"
  pull_request:
    branches:
      - main
      - staging
    paths:
      - "supabase/migrations/*.sql"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to apply migrations to"
        required: true
        default: "staging"
        type: choice
        options:
          - production
          - staging
      dry_run:
        description: "Dry run (validate only, don't apply)"
        required: false
        default: false
        type: boolean

concurrency:
  group: supabase-migrations-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel migrations in progress

env:
  SUPABASE_CLI_VERSION: "2.62.10"

jobs:
  # Determine environment based on branch
  setup-environment:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      supabase_url: ${{ steps.set-env.outputs.supabase_url }}
      supabase_key: ${{ steps.set-env.outputs.supabase_key }}
      project_ref: ${{ steps.set-env.outputs.project_ref }}
      db_password: ${{ steps.set-env.outputs.db_password }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRs always target staging for validation
            ENV="staging"
          else
            # Auto-detect from branch
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              ENV="production"
            elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
              ENV="staging"
            else
              ENV="staging"
            fi
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set environment-specific secrets
          if [ "$ENV" == "production" ]; then
            echo "supabase_url=${{ secrets.SUPABASE_URL }}" >> $GITHUB_OUTPUT
            echo "supabase_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_OUTPUT
            echo "project_ref=${{ secrets.SUPABASE_PROJECT_REF }}" >> $GITHUB_OUTPUT
            echo "db_password=${{ secrets.SUPABASE_DB_PASSWORD }}" >> $GITHUB_OUTPUT
          else
            echo "supabase_url=${{ secrets.SUPABASE_STAGING_URL }}" >> $GITHUB_OUTPUT
            echo "supabase_key=${{ secrets.SUPABASE_STAGING_SERVICE_ROLE_KEY }}" >> $GITHUB_OUTPUT
            echo "project_ref=${{ secrets.SUPABASE_STAGING_PROJECT_REF }}" >> $GITHUB_OUTPUT
            echo "db_password=${{ secrets.SUPABASE_STAGING_DB_PASSWORD }}" >> $GITHUB_OUTPUT
          fi

  # Validate migrations before applying
  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: setup-environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to detect new migrations

      - name: Install Supabase CLI
        run: |
          echo "üì¶ Installing Supabase CLI v${{ env.SUPABASE_CLI_VERSION }}..."

          # Remove any existing supabase binary or directory
          rm -rf supabase

          # Download and extract
          curl -sSfL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xzf -

          # Move to system path
          sudo mv supabase /usr/local/bin/

          # Verify installation
          supabase --version

      - name: Validate migration files syntax
        run: |
          echo "üîç Validating SQL syntax in migration files..."

          # Check for common SQL errors
          error_count=0

          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "Checking: $file"

              # Check for basic syntax issues
              if grep -q "CREAT TABLE" "$file"; then
                echo "‚ùå Error in $file: Found 'CREAT TABLE' (missing E)"
                error_count=$((error_count + 1))
              fi

              if grep -q "SELCT\|SEELCT" "$file"; then
                echo "‚ùå Error in $file: Found typo in SELECT"
                error_count=$((error_count + 1))
              fi

              # Check for missing semicolons at end of statements
              if ! tail -1 "$file" | grep -q ";"; then
                echo "‚ö†Ô∏è  Warning in $file: Last line doesn't end with semicolon"
              fi

              echo "‚úÖ $file passed basic validation"
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "‚ùå Found $error_count error(s) in migration files"
            exit 1
          fi

          echo "‚úÖ All migration files passed validation"

      - name: Check for destructive operations
        run: |
          echo "üîç Checking for potentially destructive operations..."

          # Look for dangerous operations
          dangerous_patterns=(
            "DROP DATABASE"
            "DROP SCHEMA public"
            "TRUNCATE.*CASCADE"
            "DELETE FROM.*WHERE.*1.*=.*1"
          )

          found_dangerous=false

          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              for pattern in "${dangerous_patterns[@]}"; do
                if grep -iE "$pattern" "$file" > /dev/null; then
                  echo "‚ö†Ô∏è  WARNING: Found potentially destructive operation in $file: $pattern"
                  found_dangerous=true
                fi
              done
            fi
          done

          if [ "$found_dangerous" == "true" ]; then
            echo "‚ö†Ô∏è  Destructive operations detected - proceed with caution"
            if [ "${{ needs.setup-environment.outputs.environment }}" == "production" ]; then
              echo "‚ùå Blocking destructive operations in production"
              echo "Please review migrations manually before applying"
              exit 1
            fi
          else
            echo "‚úÖ No destructive operations detected"
          fi

      - name: List new migrations
        run: |
          echo "üìù Detecting new migration files..."

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Compare against base branch
            git diff --name-only origin/${{ github.base_ref }}...HEAD -- supabase/migrations/*.sql || echo "No new migrations"
          else
            # Show all migrations
            ls -lh supabase/migrations/*.sql || echo "No migrations found"
          fi

  # Apply migrations to Supabase
  apply-migrations:
    name: Apply Migrations (${{ needs.setup-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup-environment, validate-migrations]
    if: github.event_name != 'pull_request' && github.event.inputs.dry_run != 'true'
    environment:
      name: ${{ needs.setup-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Supabase CLI
        run: |
          echo "üì¶ Installing Supabase CLI v${{ env.SUPABASE_CLI_VERSION }}..."

          # Remove any existing supabase binary or directory
          rm -rf supabase

          # Download and extract
          curl -sSfL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xzf -

          # Move to system path
          sudo mv supabase /usr/local/bin/

          # Verify installation
          supabase --version

      - name: Configure Supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ needs.setup-environment.outputs.db_password }}
          PROJECT_REF: ${{ needs.setup-environment.outputs.project_ref }}
        run: |
          echo "üîê Authenticating with Supabase..."

          # Login with access token (recommended method)
          if [ -n "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token "$SUPABASE_ACCESS_TOKEN"
            echo "‚úÖ Authenticated with access token"
          else
            echo "‚ö†Ô∏è  No access token found, will use database password"
          fi

      - name: Link to Supabase project
        env:
          PROJECT_REF: ${{ needs.setup-environment.outputs.project_ref }}
          SUPABASE_DB_PASSWORD: ${{ needs.setup-environment.outputs.db_password }}
        run: |
          echo "üîó Linking to Supabase project: $PROJECT_REF"

          # Link to the project
          supabase link --project-ref "$PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" || {
            echo "‚ùå Failed to link to Supabase project"
            echo "This might be due to:"
            echo "  1. Invalid project reference"
            echo "  2. Invalid database password"
            echo "  3. Network connectivity issues"
            echo "  4. Insufficient permissions"
            exit 1
          }

          echo "‚úÖ Successfully linked to project"

      - name: Check migration status
        run: |
          echo "üìä Checking current migration status..."

          # List applied migrations
          supabase migration list || {
            echo "‚ö†Ô∏è  Could not retrieve migration list"
          }

      - name: Apply pending migrations
        id: apply
        env:
          SUPABASE_DB_PASSWORD: ${{ needs.setup-environment.outputs.db_password }}
        run: |
          echo "üöÄ Applying pending migrations to ${{ needs.setup-environment.outputs.environment }}..."

          set +e  # Don't exit immediately on error

          # Apply migrations with detailed output
          supabase db push --password "$SUPABASE_DB_PASSWORD" 2>&1 | tee migration-output.txt

          MIGRATION_EXIT_CODE=$?

          if [ $MIGRATION_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Migrations applied successfully!"
            echo "migration_status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Migration failed!"
            echo "migration_status=failed" >> $GITHUB_OUTPUT

            # Show detailed error
            echo "=== Migration Error Details ==="
            cat migration-output.txt

            exit 1
          fi

      - name: Verify migration application
        run: |
          echo "üîç Verifying migrations were applied..."

          # Check migration status again
          supabase migration list

          echo "‚úÖ Migration verification complete"

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ needs.setup-environment.outputs.environment }}
          path: migration-output.txt
          if-no-files-found: ignore

  # Rollback on failure (optional - be careful with this)
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [setup-environment, apply-migrations]
    if: failure() && needs.setup-environment.outputs.environment == 'staging'

    steps:
      - name: Manual rollback notification
        run: |
          echo "‚ùå Migration failed in ${{ needs.setup-environment.outputs.environment }}"
          echo ""
          echo "‚ö†Ô∏è  MANUAL ROLLBACK REQUIRED"
          echo ""
          echo "To rollback, run locally:"
          echo "  supabase migration repair --status reverted <timestamp>"
          echo ""
          echo "Or restore from a backup in the Supabase Dashboard"
          echo "  https://supabase.com/dashboard/project/${{ needs.setup-environment.outputs.project_ref }}/database/backups"

  # Notification job
  notify:
    name: Notify Migration Status
    runs-on: ubuntu-latest
    needs: [setup-environment, apply-migrations]
    if: always() && github.event_name != 'pull_request'

    steps:
      - name: Migration summary
        run: |
          ENVIRONMENT="${{ needs.setup-environment.outputs.environment }}"
          STATUS="${{ needs.apply-migrations.result }}"

          echo "=== Migration Summary ==="
          echo "Environment: $ENVIRONMENT"
          echo "Status: $STATUS"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""

          if [ "$STATUS" == "success" ]; then
            echo "‚úÖ Migrations applied successfully to $ENVIRONMENT!"
          else
            echo "‚ùå Migration failed in $ENVIRONMENT"
            echo "Check the logs above for details"
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.apply-migrations.result }}';
            const environment = '${{ needs.setup-environment.outputs.environment }}';

            let message = '';
            if (status === 'success') {
              message = `‚úÖ **Database Migrations Validated**\n\n` +
                `Environment: **${environment}**\n` +
                `All migrations have been validated and are ready to apply.`;
            } else {
              message = `‚ùå **Migration Validation Failed**\n\n` +
                `Environment: **${environment}**\n` +
                `Please review the migration errors in the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
