name: Supabase Migrations

on:
  push:
    branches: [main]
    paths:
      - "supabase/migrations/*.sql"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run — validate only, don't apply"
        required: false
        default: false
        type: boolean

concurrency:
  group: supabase-migrations
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check migration file naming
        run: |
          shopt -s nullglob
          files=(supabase/migrations/*.sql)
          shopt -u nullglob

          if [ ${#files[@]} -eq 0 ]; then
            echo "No migration files found"
            exit 0
          fi

          for file in "${files[@]}"; do
            filename=$(basename "$file")
            if ! [[ "$filename" =~ ^[0-9]{14}_[a-z0-9_]+\.sql$ ]]; then
              echo "::error::Invalid migration filename: $filename (expected YYYYMMDDHHMMSS_description.sql)"
              exit 1
            fi
          done
          echo "All migration filenames are valid"

      - name: Check for destructive operations
        run: |
          for file in supabase/migrations/*.sql; do
            [ -f "$file" ] || continue
            if grep -iE "DROP DATABASE|DROP SCHEMA public|TRUNCATE.*CASCADE" "$file"; then
              echo "::error::Destructive operation found in $file — review manually before applying"
              exit 1
            fi
          done
          echo "No destructive operations detected"

  apply:
    name: Apply Migrations
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.dry_run != 'true'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}" \
                        --password "${{ secrets.SUPABASE_DB_PASSWORD }}"

      - name: Push pending migrations
        run: |
          supabase db push --password "${{ secrets.SUPABASE_DB_PASSWORD }}" 2>&1 | tee migration-output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Migration failed — see logs above"
            exit 1
          fi
          echo "Migrations applied successfully"

      - name: Verify migration status
        run: supabase migration list

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs
          path: migration-output.txt
          if-no-files-found: ignore
