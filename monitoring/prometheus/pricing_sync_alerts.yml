# Prometheus Alert Rules for Pricing Sync Scheduler
# Phase 6: Monitoring & Alerts
#
# These alert rules monitor the automated pricing sync scheduler health
# and performance. Configure these rules in your Prometheus instance.
#
# Usage:
#   1. Copy this file to your Prometheus rules directory
#   2. Add to prometheus.yml:
#      rule_files:
#        - "pricing_sync_alerts.yml"
#   3. Reload Prometheus: curl -X POST http://localhost:9090/-/reload
#
# Alert Routing:
#   - Critical alerts ‚Üí PagerDuty + Slack
#   - Warning alerts ‚Üí Slack only

groups:
  - name: pricing_sync_scheduler
    interval: 60s  # Evaluate every 60 seconds
    rules:
      # ============================================================
      # CRITICAL ALERTS (Page + Slack)
      # ============================================================

      - alert: PricingSyncSchedulerStopped
        expr: time() - pricing_last_sync_timestamp > 28800
        for: 5m
        labels:
          severity: critical
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing sync scheduler has stopped"
          description: |
            The pricing sync scheduler has not completed a sync in over 8 hours.

            Last sync: {{ $value | humanizeDuration }} ago
            Expected interval: 6 hours
            Grace period: 2 hours

            Impact: Pricing data may become stale, affecting billing accuracy.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-stopped
          action: |
            1. Check scheduler status: GET /admin/pricing/scheduler/status
            2. Check application logs: railway logs | grep pricing
            3. Verify PRICING_SYNC_ENABLED=true
            4. Try manual trigger: POST /admin/pricing/scheduler/trigger
            5. If manual trigger fails, check provider API keys
            6. Restart application if needed: railway redeploy

      - alert: PricingSyncHighErrorRate
        expr: |
          (
            rate(pricing_scheduled_sync_runs_total{status="failed"}[1h])
            / rate(pricing_scheduled_sync_runs_total[1h])
          ) > 0.5
        for: 15m
        labels:
          severity: critical
          component: pricing_sync
          team: platform
        annotations:
          summary: "High error rate in pricing sync scheduler"
          description: |
            The pricing sync scheduler is experiencing a high error rate.

            Error rate: {{ $value | humanizePercentage }}
            Threshold: 50%
            Time window: Last 1 hour

            Impact: Pricing data is not being updated, affecting billing accuracy.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-errors
          action: |
            1. Check recent error logs: railway logs | grep "Scheduled pricing sync failed"
            2. Check Sentry for error traces
            3. Verify provider API keys are valid
            4. Check provider API status (openrouter.ai, featherless.ai, etc)
            5. Check database connectivity
            6. Check rate limits on provider APIs
            7. Review detailed error messages for root cause

      - alert: PricingSyncNoRunsRecorded
        expr: increase(pricing_scheduled_sync_runs_total[8h]) == 0
        for: 10m
        labels:
          severity: critical
          component: pricing_sync
          team: platform
        annotations:
          summary: "No pricing sync runs recorded in 8 hours"
          description: |
            The pricing sync scheduler has not recorded any runs in 8 hours.
            This is different from syncs failing - there's no activity at all.

            Time since last run: 8+ hours
            Expected: At least 1-2 runs in 8 hours (6h interval)

            Impact: Pricing data is not being updated at all.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-no-runs
          action: |
            1. Check if scheduler is enabled: railway variables | grep PRICING_SYNC_ENABLED
            2. Check if app is running: curl https://api.gatewayz.ai/health
            3. Check startup logs: railway logs | grep "Pricing sync scheduler"
            4. Check for Python exceptions during startup
            5. Verify background task was created
            6. Check if asyncio event loop is running
            7. Restart application: railway redeploy

      - alert: PricingSyncDatabaseUpdateFailures
        expr: |
          rate(pricing_models_update_errors_total[1h]) > 0.1
        for: 10m
        labels:
          severity: critical
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing sync experiencing database update failures"
          description: |
            The pricing sync is completing but failing to update the database.

            Error rate: {{ $value }} errors/sec
            Threshold: 0.1 errors/sec

            Impact: Pricing data fetch succeeds but database remains stale.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-db-errors
          action: |
            1. Check database connectivity: psql $SUPABASE_URL -c "SELECT 1"
            2. Check database logs for constraint violations
            3. Verify model_pricing table schema
            4. Check for database locks or deadlocks
            5. Verify Supabase API key is valid
            6. Check database connection pool health

      # ============================================================
      # WARNING ALERTS (Slack only)
      # ============================================================

      - alert: PricingSyncSlowDuration
        expr: |
          (
            rate(pricing_scheduled_sync_duration_seconds_sum[1h])
            / rate(pricing_scheduled_sync_duration_seconds_count[1h])
          ) > 60
        for: 30m
        labels:
          severity: warning
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing sync taking longer than expected"
          description: |
            The pricing sync scheduler is taking longer than expected to complete.

            Average duration: {{ $value | humanizeDuration }}
            Threshold: 60 seconds
            Time window: Last 1 hour

            Impact: Potential performance degradation, but not critical.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-slow
          action: |
            1. Check metrics: curl /metrics | grep pricing_scheduled_sync_duration
            2. Check database query performance
            3. Check provider API response times
            4. Check network latency to providers
            5. Consider reducing number of providers
            6. Consider increasing sync interval
            7. Monitor for further degradation

      - alert: PricingSyncLowModelsUpdated
        expr: |
          (
            rate(pricing_models_synced_total[1h])
            / rate(pricing_scheduled_sync_runs_total[1h])
          ) < 50
        for: 2h
        labels:
          severity: warning
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing sync updating fewer models than expected"
          description: |
            The pricing sync is completing but updating fewer models than normal.

            Average models per sync: {{ $value }}
            Expected: 100-300 models per provider
            Threshold: < 50 models per sync

            Impact: Some models may have stale pricing data.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-low-updates
          action: |
            1. Check provider API responses for reduced model counts
            2. Verify provider configurations in PRICING_SYNC_PROVIDERS
            3. Check if providers have deprecated models
            4. Review provider API change logs
            5. Verify model transformation logic still works
            6. Check for filtering issues in sync logic

      - alert: PricingSyncMemoryUsageHigh
        expr: |
          (
            process_resident_memory_bytes{job="gatewayz-api"}
            / 1024 / 1024 / 1024
          ) > 2
        for: 15m
        labels:
          severity: warning
          component: pricing_sync
          team: platform
        annotations:
          summary: "High memory usage during pricing sync"
          description: |
            The application memory usage is high, possibly due to pricing sync.

            Current memory: {{ $value | humanize }}GB
            Threshold: 2GB

            Impact: Potential OOM kills if memory continues to grow.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-memory
          action: |
            1. Check memory usage: railway logs | grep memory
            2. Monitor memory during next sync cycle
            3. Check for memory leaks in sync code
            4. Consider batch processing instead of loading all models
            5. Profile memory usage with memory_profiler
            6. Scale up application if needed

      - alert: PricingSyncProviderTimeout
        expr: |
          rate(pricing_provider_timeouts_total[30m]) > 0
        for: 30m
        labels:
          severity: warning
          component: pricing_sync
          team: platform
        annotations:
          summary: "Provider API timeouts during pricing sync"
          description: |
            One or more providers are timing out during pricing sync.

            Timeout rate: {{ $value }} timeouts/sec
            Provider: {{ $labels.provider }}

            Impact: Partial sync failures, some providers not updated.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-timeouts
          action: |
            1. Check which provider is timing out: {{ $labels.provider }}
            2. Check provider API status page
            3. Test provider API manually: curl provider_endpoint
            4. Check network connectivity to provider
            5. Consider increasing timeout values
            6. Consider removing slow provider temporarily

      - alert: PricingSyncStaleData
        expr: |
          (time() - pricing_last_sync_timestamp) > 21600
        for: 1h
        labels:
          severity: warning
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing data is becoming stale"
          description: |
            Pricing data has not been updated in over 6 hours (1 interval).

            Last sync: {{ $value | humanizeDuration }} ago
            Expected interval: 6 hours

            Impact: Data staleness warning, not yet critical.

            Runbook: https://docs.gatewayz.ai/runbooks/pricing-sync-stale
          action: |
            1. Check if scheduler is running normally
            2. Check recent logs for any issues
            3. Verify next sync is scheduled
            4. Monitor for missed intervals
            5. If pattern continues, escalate to critical

      # ============================================================
      # INFORMATIONAL ALERTS (Logging only)
      # ============================================================

      - alert: PricingSyncCompleted
        expr: rate(pricing_scheduled_sync_runs_total{status="success"}[10m]) > 0
        for: 0m
        labels:
          severity: info
          component: pricing_sync
          team: platform
        annotations:
          summary: "Pricing sync completed successfully"
          description: |
            A pricing sync has completed successfully.

            Status: Success

            This is an informational alert for monitoring purposes.

      - alert: PricingSyncProviderAdded
        expr: |
          count(count by (provider) (pricing_models_synced_total)) > 4
        for: 5m
        labels:
          severity: info
          component: pricing_sync
          team: platform
        annotations:
          summary: "New provider detected in pricing sync"
          description: |
            A new provider has been added to the pricing sync.

            Provider count: {{ $value }}
            Expected: 4 (openrouter, featherless, nearai, alibaba-cloud)

            This is an informational alert to track provider changes.

# ============================================================
# Alert Grouping and Routing Configuration
# ============================================================
#
# Configure in Alertmanager (alertmanager.yml):
#
# route:
#   group_by: ['alertname', 'component']
#   group_wait: 30s
#   group_interval: 5m
#   repeat_interval: 4h
#   receiver: 'default'
#   routes:
#     - match:
#         severity: critical
#         component: pricing_sync
#       receiver: 'pagerduty-platform'
#       continue: true
#     - match:
#         severity: critical
#         component: pricing_sync
#       receiver: 'slack-critical'
#     - match:
#         severity: warning
#         component: pricing_sync
#       receiver: 'slack-warnings'
#     - match:
#         severity: info
#         component: pricing_sync
#       receiver: 'null'
#
# receivers:
#   - name: 'default'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK_URL'
#         channel: '#platform-alerts'
#   - name: 'pagerduty-platform'
#     pagerduty_configs:
#       - service_key: 'YOUR_PAGERDUTY_KEY'
#   - name: 'slack-critical'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK_URL'
#         channel: '#platform-critical'
#         title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
#   - name: 'slack-warnings'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK_URL'
#         channel: '#platform-warnings'
#         title: '‚ö†Ô∏è  WARNING: {{ .GroupLabels.alertname }}'
#   - name: 'null'
