[build]
builder = "NIXPACKS"

[deploy]
startCommand = "bash start.sh"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# Health check configuration for Railway
# Using /health/railway endpoint for proper health validation
# This endpoint validates:
# - Database connectivity
# - Redis/health cache availability
# - Minimum gateway health threshold (30%)
# Returns HTTP 200 during warmup, enabling Railway to mark service healthy
#
# Timing: App loads 50+ routes, initializes Supabase (with retries),
# and starts 10+ background tasks - needs ~60-90s to be fully ready.
# Previous 30s timeout caused deployment failures on cold containers.
healthcheckPath = "/health/railway"
healthcheckTimeout = 120
healthcheckInterval = 10
initialDelaySeconds = 30

# ============================================
# Cron Jobs - Automated Model & Pricing Sync
# ============================================
# Railway native cron jobs for automated synchronization
# Docs: https://docs.railway.app/reference/config-as-code#crons

# Full model sync every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
# Using background=true to prevent timeouts
[[crons]]
schedule = "0 */6 * * *"
command = "curl -X POST 'http://localhost:$PORT/admin/model-sync/full?background=true'"

# Alternative schedules (uncomment to use instead):

# Daily at 2 AM UTC
# [[crons]]
# schedule = "0 2 * * *"
# command = "curl -X POST http://localhost:$PORT/admin/model-sync/all"

# Twice daily (2 AM and 2 PM UTC)
# [[crons]]
# schedule = "0 2,14 * * *"
# command = "curl -X POST http://localhost:$PORT/admin/model-sync/all"

# Every 4 hours
# [[crons]]
# schedule = "0 */4 * * *"
# command = "curl -X POST http://localhost:$PORT/admin/model-sync/all"

# Health monitoring every hour (optional)
# [[crons]]
# schedule = "0 * * * *"
# command = "python scripts/monitor_sync_health.py"
