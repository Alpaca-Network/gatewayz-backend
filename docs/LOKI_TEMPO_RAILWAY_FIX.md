# Loki & Tempo Configuration Fix for Railway

**Issue**: Loki and Tempo services are crashing on Railway with configuration errors.

**Error Message**:
```
failed parsing config: /etc/loki/loki-config.yaml: yaml: unmarshal errors:
  line 46: field shared_store not found in type compactor.Config
```

**Root Cause**: The Loki configuration contains an invalid `shared_store` field in the compactor section that isn't recognized by the Loki version running on Railway. This is a version compatibility issue.

---

## üö® IMMEDIATE FIX (Recommended)

### Option 1: Disable Loki & Tempo (Fastest Solution)

The backend gracefully handles Loki being disabled. You can safely disable them without affecting functionality.

**Steps**:
1. Go to Railway Dashboard: https://railway.app/dashboard
2. Select your project (gatewayz-api)
3. For each service (Loki, Tempo):
   - Click the service name
   - Click "Settings"
   - Scroll down to "Danger Zone"
   - Click "Remove Service"
4. Redeploy the application:
   ```bash
   git push origin staging
   ```

**Result**: Application starts cleanly without Loki/Tempo. The backend will log to console instead of sending to Loki.

**Why this works**:
- Backend checks `LOKI_ENABLED` environment variable (defaults to `false`)
- If disabled, logging falls back to console output
- No Loki push URL needed
- Health checks continue to pass

---

### Option 2: Fix the Loki Configuration

If you want to keep Loki/Tempo, you need to fix the configuration.

**Problem**: The Loki container is using an outdated or incorrect configuration template.

**Steps to Fix**:

1. **Identify the configuration source**:
   - Loki config is at `/etc/loki/loki-config.yaml` (inside the container)
   - This is typically generated by Railway or mounted from a service template

2. **In Railway Dashboard**:
   - Go to the Loki service
   - Check if there's an environment variable for configuration
   - Look for: `LOKI_CONFIG`, `LOKI_CONFIGURATION`, or similar

3. **Find the offending line** (line 46 in the error):
   - The `shared_store` field in the `compactor` section
   - This field doesn't exist in modern Loki versions

4. **Fix the configuration** by removing the `shared_store` field:

   **Invalid** ‚ùå:
   ```yaml
   compactor:
     shared_store: filesystem
     working_directory: /loki/boltdb-shipper-compactor
   ```

   **Valid** ‚úÖ:
   ```yaml
   compactor:
     working_directory: /loki/boltdb-shipper-compactor
     shared_store: filesystem  # REMOVE THIS LINE
   ```

5. **Update the Loki service**:
   - If using Railway template, delete and re-add with correct version
   - If using custom config, update the environment variable with fixed YAML
   - Ensure Loki version is 2.7+ (supports modern config)

---

## üìã Understanding the Configuration Error

### What is `shared_store`?

The `shared_store` field was used in older Loki versions (< 2.5) to specify where the compactor stores its state. In modern Loki:

- The compactor uses the main storage backend (object storage like S3)
- No separate `shared_store` field is needed
- Configuration is done through the main storage section

### Modern Loki Compactor Config

**Correct format** for Loki 2.7+:
```yaml
compactor:
  working_directory: /loki/boltdb-shipper-compactor
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    shared_store: filesystem
    cache_location: /loki/boltdb-shipper-cache
```

Note: `shared_store` is under `storage_config.boltdb_shipper`, NOT under `compactor`.

---

## ‚úÖ Verification

### To verify the fix works:

1. **After disabling Loki/Tempo**:
   ```bash
   # Check if deployment succeeds
   railway logs --follow
   # Should see: "‚úÖ Application started on http://0.0.0.0:8000"
   ```

2. **Test the health endpoint**:
   ```bash
   curl https://your-railway-url/health
   # Should return: {"status":"healthy",...}
   ```

3. **Check logs**:
   ```bash
   # Logs should appear in Railway UI under "Logs" tab
   railway logs --lines 100
   ```

---

## üîß Complete Minimal Loki Config (If You Want to Fix It)

If you need Loki configuration that works on Railway:

```yaml
auth_enabled: false

ingester:
  chunk_idle_period: 3m
  max_chunk_age: 1h
  chunk_retain_period: 1m
  max_streams_per_user: 10000
  enforce_rate_limit_defaults: false

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  ingestion_rate_mb: 8
  ingestion_burst_size_mb: 16
  max_cache_freshness_per_query: 10m

schema_config:
  configs:
  - from: 2020-10-24
    store: boltdb-shipper
    object_store: filesystem
    schema: v11
    index:
      prefix: index_
      period: 24h

server:
  http_listen_port: 3100
  log_level: info

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s
```

**Note**: This is a minimal config without the invalid `compactor.shared_store` field.

---

## üìä Current Logging Setup

### With Loki Disabled (Current Status):
- ‚úÖ Console logging: All logs appear in Railway UI
- ‚úÖ Application performance: No Loki overhead
- ‚úÖ Health checks: Always pass
- ‚ùå No external log aggregation (logs lost when container restarts)

### With Loki Enabled (After Fix):
- ‚úÖ Persistent logging: Logs stored in Loki
- ‚úÖ Grafana integration: Query logs via Grafana
- ‚úÖ Long-term retention: Don't lose logs
- ‚ö†Ô∏è Additional infrastructure: Loki service overhead

---

## üéØ Recommended Action

**For now**: Disable Loki and Tempo
- Quick fix (5 minutes)
- Application works perfectly without them
- Can add back later when configuration is fixed

**Later**: If you need persistent logging:
1. Use Railway's built-in logging (exported to external service)
2. Or properly configure Loki with correct version/config
3. Or use Grafana Cloud Loki (managed service)

---

## üöÄ Next Steps

1. **Immediate**: Remove Loki and Tempo services from Railway
2. **Redeploy**: Push any changes and verify deployment succeeds
3. **Verify**: Check that `/health` endpoint returns healthy status
4. **Monitor**: Use Railway's built-in logs for debugging

---

## Commands to Remove Services

```bash
# SSH into Railway and check running services
railway shell

# Inside container:
ps aux | grep -E "loki|tempo"

# Exit
exit
```

---

## Resources

- [Loki Configuration Documentation](https://grafana.com/docs/loki/latest/configuration/)
- [Railway Documentation](https://docs.railway.app)
- [Loki Compactor Documentation](https://grafana.com/docs/loki/latest/operations/storage/table-manager/#compactor)

---

**Status**: ‚úÖ Recommended Fix Created
**Date**: 2025-12-26
**Action**: Remove Loki/Tempo from Railway Dashboard and redeploy
