# Claude Code Metrics Dashboard

This guide explains how to set up and use the Claude Code Metrics Dashboard for monitoring AI-assisted development activity.

## Overview

The Claude Code Metrics Dashboard provides comprehensive monitoring of Claude Code usage with the following key metrics:

- **Token Usage**: Track input, output, cache read, and cache creation tokens
- **Cost Tracking**: Monitor API costs by model
- **Productivity Metrics**: CLI vs user active time, productivity ratio
- **Activity Metrics**: Commits made, lines of code accepted
- **Efficiency Metrics**: Cache efficiency percentage, cost per 1K output tokens

## Dashboard Location

The dashboard JSON file is located at:
```
dashboards/claude-code-metrics.json
```

## Metrics Exposed

### Token Usage Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `claude_code_token_usage_tokens_total` | Counter | `session_id`, `type`, `model` | Total tokens used by Claude Code sessions |

Token types:
- `input` - Tokens sent to Claude
- `output` - Tokens generated by Claude
- `cacheRead` - Tokens read from cache (cost savings)
- `cacheCreation` - Tokens written to cache

### Cost Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `claude_code_cost_usage_USD_total` | Counter | `model` | Total API cost in USD |

### Activity Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `claude_code_active_time_seconds_total` | Counter | `type` | Total active time in seconds |
| `claude_code_commit_count_total` | Counter | - | Total commits made via Claude Code |
| `claude_code_lines_of_code_count_total` | Counter | - | Lines of code accepted from suggestions |

Active time types:
- `cli` - Time Claude CLI spent actively working
- `user` - Time user spent interacting with Claude

## Dashboard Panels

The dashboard includes 21 panels organized into sections:

### Overview Section
1. **Sessions** - Total Claude Code sessions tracked
2. **Commits Made** - Total commits made via Claude Code
3. **Active Time (CLI)** - Time Claude spent actively working
4. **Active Time (You)** - Time you spent interacting
5. **Total Cost** - Total API cost in USD
6. **Lines of Code** - Lines of code accepted

### Token Metrics Section
7. **Input Tokens** - Tokens sent to Claude
8. **Output Tokens** - Tokens generated by Claude
9. **Cache Read** - Tokens read from cache
10. **Cache Creation** - Tokens written to cache
11. **Cache Efficiency** - Percentage of input served from cache
12. **Cost per 1K Output** - Average cost per 1000 output tokens

### Distribution Charts
13. **Tokens by Type** - Donut chart of token distribution
14. **Tokens by Model** - Donut chart by model
15. **Cost by Model** - Bar gauge showing cost breakdown
16. **Active Time Distribution** - CLI vs User time distribution

### Productivity Metrics
17. **Productivity Ratio** - CLI time / User time (higher = Claude doing more)
18. **Peak Leverage** - Highest productivity ratio in time window

### Time Series Charts
19. **Token Usage Over Time** - Token consumption rate by type
20. **Token Usage by Model Over Time** - Token rate by model
21. **Cost Over Time** - API cost accumulation rate
22. **Active Time Over Time** - CLI and User activity rate

## Recording Metrics in Code

### Python API

```python
from src.services.prometheus_metrics import (
    record_claude_code_tokens,
    record_claude_code_cost,
    record_claude_code_active_time,
    record_claude_code_commit,
    record_claude_code_lines_of_code,
)

# Record token usage
record_claude_code_tokens(
    session_id="session-abc123",
    model="claude-3-sonnet",
    input_tokens=1000,
    output_tokens=500,
    cache_read_tokens=200,
    cache_creation_tokens=100,
)

# Record cost
record_claude_code_cost(
    model="claude-3-sonnet",
    cost_usd=0.05,
)

# Record active time
record_claude_code_active_time(
    cli_seconds=120.5,
    user_seconds=30.0,
)

# Record commit
record_claude_code_commit()

# Record lines of code
record_claude_code_lines_of_code(lines=150)
```

## Setting Up the Dashboard

### Prerequisites

1. **Prometheus** instance (v2.0+) scraping your API's `/metrics` endpoint
2. **Grafana** instance (v12.0+ for best compatibility, v8.0+ minimum)

### Import Dashboard

#### Option 1: Import from File

1. Open Grafana and navigate to **Dashboards** > **Import**
2. Click **Upload JSON file**
3. Select `dashboards/claude-code-metrics.json`
4. Select your Prometheus data source
5. Click **Import**

#### Option 2: Copy-Paste JSON

1. Open Grafana and navigate to **Dashboards** > **Import**
2. Open `dashboards/claude-code-metrics.json` in a text editor
3. Copy the entire JSON content
4. Paste into the "Import via panel json" text area
5. Click **Load**
6. Select your Prometheus data source
7. Click **Import**

### Configure Prometheus Scraping

Ensure your `prometheus.yml` includes the Gatewayz API target:

```yaml
scrape_configs:
  - job_name: 'gatewayz-api'
    scrape_interval: 10s
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: /metrics
```

## Example Prometheus Queries

### Total Sessions
```promql
count(count by (session_id)(claude_code_token_usage_tokens_total))
```

### Total Cost
```promql
sum(claude_code_cost_usage_USD_total)
```

### Cache Efficiency
```promql
sum(claude_code_token_usage_tokens_total{type="cacheRead"}) /
(sum(claude_code_token_usage_tokens_total{type="cacheRead"}) +
 sum(claude_code_token_usage_tokens_total{type="input"})) * 100
```

### Productivity Ratio
```promql
sum(claude_code_active_time_seconds_total{type="cli"}) /
sum(claude_code_active_time_seconds_total{type="user"})
```

### Token Usage Rate (5-minute window)
```promql
sum by (type) (rate(claude_code_token_usage_tokens_total[5m]))
```

### Cost by Model
```promql
sum by (model) (claude_code_cost_usage_USD_total)
```

## Dashboard Tags

The dashboard is tagged with:
- `claude`
- `productivity`
- `ai`
- `development`

## Time Range

Default time range: **Last 1 hour**

Recommended refresh intervals:
- Active development: 10s - 30s
- General monitoring: 1m - 5m

## Troubleshooting

### No Data Showing

1. Verify the API is running and `/metrics` endpoint is accessible
2. Check Prometheus is scraping the target successfully
3. Ensure metrics are being recorded (call the helper functions)
4. Verify the Prometheus data source is configured correctly in Grafana

### Metrics Not Appearing in /metrics

1. Check that the prometheus_metrics module is imported in your code
2. Verify no exceptions during metric registration (check logs)
3. Confirm the metrics endpoint returns Prometheus text format

### High Cardinality Warning

The `session_id` label can cause high cardinality if many sessions are tracked. Consider:
- Using a shorter session ID format
- Implementing session ID rotation
- Setting Prometheus retention policies

## Related Documentation

- [Grafana FastAPI Observability Setup](./GRAFANA_FASTAPI_OBSERVABILITY_SETUP.md)
- [Prometheus Setup](./PROMETHEUS_SETUP.md)
- [OpenTelemetry Setup](./OPENTELEMETRY_SETUP.md)
- [Performance Monitoring](./PERFORMANCE_MONITORING.md)
