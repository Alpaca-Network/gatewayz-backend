-- Update email templates with professional design (Secure Final Version)
-- This migration updates existing templates and adds new ones without API key exposure

-- Update existing templates with professional design
UPDATE notification_templates SET 
    html_template = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Low Trial Credits Alert</title><style>@import url(''https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'');*{margin:0;padding:0;box-sizing:border-box}body{font-family:''Inter'',-apple-system,BlinkMacSystemFont,''Segoe UI'',Roboto,sans-serif;line-height:1.6;color:#1f2937;background-color:#f9fafb}.email-container{max-width:600px;margin:0 auto;background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}.header h1{font-size:28px;font-weight:700;margin-bottom:8px}.content{padding:40px 30px}.content h2{font-size:24px;font-weight:600;color:#1f2937;margin-bottom:16px}.content p{font-size:16px;color:#4b5563;margin-bottom:20px}.warning-box{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:20px;margin:20px 0}.cta-button{display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:16px;margin:20px 0}.footer{background:#f8fafc;padding:30px;text-align:center;border-top:1px solid #e5e7eb}</style></head><body><div class="email-container"><div class="header"><h1>{app_name}</h1><p>Low Trial Credits Alert</p></div><div class="content"><h2>‚ö†Ô∏è Trial Credits Running Low</h2><p>Hi <strong>{username}</strong>,</p><p>Your trial credits are running low! Don''t worry, we''ve got you covered with upgrade options.</p><div class="warning-box"><h3 style="margin-bottom:12px;color:#92400e">Current Status</h3><p><strong>Current Credits:</strong> ${current_credits}</p><p><strong>Alert Threshold:</strong> ${threshold}</p></div><div style="text-align:center;margin:30px 0"><a href="{upgrade_url}" class="cta-button">üíé View Plans & Upgrade</a></div><p>Questions? Contact us at <a href="mailto:support@gatewayz.ai" style="color:#3b82f6">support@gatewayz.ai</a></p></div><div class="footer"><p>¬© 2024 {app_name}. All rights reserved.</p></div></div></body></html>',
    text_template = 'Low Trial Credits Alert - {app_name}\n\nHi {username},\n\nYour trial credits are running low!\n\nCurrent Credits: ${current_credits}\nAlert Threshold: ${threshold}\n\nTo continue using the API, please upgrade to a paid plan.\n\nView Plans: {upgrade_url}\n\nQuestions? Contact us: support@gatewayz.ai\n\nBest regards,\nThe {app_name} Team'
WHERE id = 'low_balance_trial';

-- Add new professional email templates (SECURE VERSION - NO API KEY EXPOSURE)
INSERT INTO notification_templates (id, type, subject, html_template, text_template, variables) VALUES 
(
    'welcome_email',
    'welcome',
    'Welcome to {app_name}! Your account is ready üöÄ',
    '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Welcome to {app_name}</title><style>@import url(''https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'');*{margin:0;padding:0;box-sizing:border-box}body{font-family:''Inter'',-apple-system,BlinkMacSystemFont,''Segoe UI'',Roboto,sans-serif;line-height:1.6;color:#1f2937;background-color:#f9fafb}.email-container{max-width:600px;margin:0 auto;background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}.header h1{font-size:28px;font-weight:700;margin-bottom:8px}.content{padding:40px 30px}.content h2{font-size:24px;font-weight:600;color:#1f2937;margin-bottom:16px}.success-box{background:#d1fae5;border:1px solid #10b981;border-radius:8px;padding:20px;margin:20px 0}.highlight-box{background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%);border:1px solid #d1d5db;border-radius:8px;padding:24px;margin:24px 0}.cta-button{display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:16px;margin:20px 0}.footer{background:#f8fafc;padding:30px;text-align:center;border-top:1px solid #e5e7eb}</style></head><body><div class="email-container"><div class="header"><h1>{app_name}</h1><p>Your AI Gateway is ready</p></div><div class="content"><h2>Welcome to {app_name}! üéâ</h2><p>Hi <strong>{username}</strong>,</p><p>Welcome to {app_name}! We''re excited to have you on board. Your account has been successfully created and you''re ready to start building amazing AI-powered applications.</p><div class="success-box"><h3 style="margin-bottom:12px;color:#065f46">üöÄ Your Account is Ready!</h3><p style="margin-bottom:0;color:#047857">You''ve received <strong>${credits}</strong> in free credits to get started with our API.</p></div><div class="highlight-box"><h3 style="margin-bottom:16px">üîë Your API Key</h3><p style="margin-bottom:12px">Your API key has been generated and is available in your dashboard. For security reasons, we don''t include API keys in emails.</p><div style="text-align:center;margin:20px 0"><a href="{app_url}/dashboard" class="cta-button">üîê View API Key in Dashboard</a></div><p style="font-size:14px;color:#6b7280;margin-top:12px">‚ö†Ô∏è Keep your API key secure and never share it publicly.</p></div><div style="text-align:center;margin:30px 0"><a href="{app_url}/docs" class="cta-button">üìö View Documentation</a><a href="{app_url}/dashboard" class="cta-button" style="background:#f8fafc;color:#374151;border:1px solid #d1d5db">üìä Go to Dashboard</a></div><p>If you have any questions, don''t hesitate to reach out to our support team at <a href="mailto:support@gatewayz.ai" style="color:#3b82f6">support@gatewayz.ai</a>.</p></div><div class="footer"><p>¬© 2024 {app_name}. All rights reserved.</p><p>This email was sent to {email}</p></div></div></body></html>',
    'Welcome to {app_name}!\n\nHi {username},\n\nWelcome to {app_name}! We''re excited to have you on board.\n\nYour Account Details:\n- Free Credits: ${credits}\n- Trial Period: 3 days\n\nYour API key is available in your dashboard for security reasons.\n\nQuick Start:\n1. Access your dashboard: {app_url}/dashboard\n2. Read our documentation: {app_url}/docs\n3. Try our playground: {app_url}/playground\n4. Check out examples: {app_url}/examples\n\nKeep your API key secure and never share it publicly.\n\nQuestions? Contact us: support@gatewayz.ai\n\nBest regards,\nThe {app_name} Team',
    ARRAY['username', 'email', 'credits', 'app_name', 'app_url']
),
(
    'password_reset',
    'password_reset',
    'Reset your {app_name} password',
    '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Password Reset - {app_name}</title><style>@import url(''https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'');*{margin:0;padding:0;box-sizing:border-box}body{font-family:''Inter'',-apple-system,BlinkMacSystemFont,''Segoe UI'',Roboto,sans-serif;line-height:1.6;color:#1f2937;background-color:#f9fafb}.email-container{max-width:600px;margin:0 auto;background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}.content{padding:40px 30px}.highlight-box{background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%);border:1px solid #d1d5db;border-radius:8px;padding:24px;margin:24px 0}.cta-button{display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:16px;margin:20px 0}.footer{background:#f8fafc;padding:30px;text-align:center;border-top:1px solid #e5e7eb}</style></head><body><div class="email-container"><div class="header"><h1>{app_name}</h1><p>Password Reset Request</p></div><div class="content"><h2>üîê Password Reset Request</h2><p>Hi <strong>{username}</strong>,</p><p>We received a request to reset your password for your {app_name} account.</p><div class="highlight-box"><h3 style="margin-bottom:12px">Reset Your Password</h3><p style="margin-bottom:16px">Click the button below to create a new password:</p><div style="text-align:center"><a href="{reset_url}" class="cta-button">üîë Reset Password</a></div><p style="font-size:14px;color:#6b7280;margin-top:16px">This link will expire in 1 hour for security reasons.</p></div><p>If you didn''t request this password reset, please contact our support team immediately at <a href="mailto:support@gatewayz.ai" style="color:#3b82f6">support@gatewayz.ai</a>.</p></div><div class="footer"><p>¬© 2024 {app_name}. All rights reserved.</p></div></div></body></html>',
    'Password Reset Request - {app_name}\n\nHi {username},\n\nWe received a request to reset your password for your {app_name} account.\n\nReset your password by clicking this link:\n{reset_url}\n\nThis link will expire in 1 hour for security reasons.\n\nIf you didn''t request this password reset, please ignore this email or contact our support team at support@gatewayz.ai.\n\nBest regards,\nThe {app_name} Team',
    ARRAY['username', 'reset_url', 'app_name']
),
(
    'monthly_usage_report',
    'usage_report',
    'Monthly Usage Report - {month} | {app_name}',
    '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Monthly Usage Report - {app_name}</title><style>@import url(''https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'');*{margin:0;padding:0;box-sizing:border-box}body{font-family:''Inter'',-apple-system,BlinkMacSystemFont,''Segoe UI'',Roboto,sans-serif;line-height:1.6;color:#1f2937;background-color:#f9fafb}.email-container{max-width:600px;margin:0 auto;background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}.content{padding:40px 30px}.highlight-box{background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%);border:1px solid #d1d5db;border-radius:8px;padding:24px;margin:24px 0}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:20px 0}.info-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:16px;text-align:center}.info-item .label{font-size:14px;color:#64748b;font-weight:500;margin-bottom:4px}.info-item .value{font-size:18px;font-weight:600;color:#1e293b}.cta-button{display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:16px;margin:20px 0}.footer{background:#f8fafc;padding:30px;text-align:center;border-top:1px solid #e5e7eb}</style></head><body><div class="email-container"><div class="header"><h1>{app_name}</h1><p>Monthly Usage Report</p></div><div class="content"><h2>üìä Monthly Usage Report - {month}</h2><p>Hi <strong>{username}</strong>,</p><p>Here''s your monthly usage summary for {month}. Keep track of your API consumption and optimize your usage.</p><div class="highlight-box"><h3 style="margin-bottom:16px">üìà Usage Summary</h3><div class="info-grid"><div class="info-item"><div class="label">Total Requests</div><div class="value">{total_requests:,}</div></div><div class="info-item"><div class="label">Tokens Used</div><div class="value">{tokens_used:,}</div></div><div class="info-item"><div class="label">Credits Spent</div><div class="value">${credits_spent:.2f}</div></div><div class="info-item"><div class="label">Remaining Credits</div><div class="value">${remaining_credits:.2f}</div></div></div></div><div style="text-align:center;margin:30px 0"><a href="{app_url}/dashboard" class="cta-button">üìä View Detailed Analytics</a></div><p>Questions about your usage? Contact our team at <a href="mailto:support@gatewayz.ai" style="color:#3b82f6">support@gatewayz.ai</a>.</p></div><div class="footer"><p>¬© 2024 {app_name}. All rights reserved.</p></div></div></body></html>',
    'Monthly Usage Report - {app_name}\n\nHi {username},\n\nHere''s your monthly usage summary for {month}:\n\nTotal Requests: {total_requests:,}\nTokens Used: {tokens_used:,}\nCredits Spent: ${credits_spent:.2f}\nRemaining Credits: ${remaining_credits:.2f}\n\nView detailed analytics: {app_url}/dashboard\n\nQuestions? Contact us: support@gatewayz.ai\n\nBest regards,\nThe {app_name} Team',
    ARRAY['username', 'month', 'total_requests', 'tokens_used', 'credits_spent', 'remaining_credits', 'app_name', 'app_url']
),
(
    'api_key_created',
    'api_key_created',
    'New API key ''{key_name}'' created - {app_name}',
    '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>New API Key - {app_name}</title><style>@import url(''https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'');*{margin:0;padding:0;box-sizing:border-box}body{font-family:''Inter'',-apple-system,BlinkMacSystemFont,''Segoe UI'',Roboto,sans-serif;line-height:1.6;color:#1f2937;background-color:#f9fafb}.email-container{max-width:600px;margin:0 auto;background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}.content{padding:40px 30px}.highlight-box{background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%);border:1px solid #d1d5db;border-radius:8px;padding:24px;margin:24px 0}.cta-button{display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:16px;margin:20px 0}.footer{background:#f8fafc;padding:30px;text-align:center;border-top:1px solid #e5e7eb}</style></head><body><div class="email-container"><div class="header"><h1>{app_name}</h1><p>New API Key Created</p></div><div class="content"><h2>üîë New API Key Created</h2><p>Hi <strong>{username}</strong>,</p><p>A new API key has been created for your account.</p><div class="highlight-box"><h3 style="margin-bottom:12px">API Key Details</h3><p><strong>Key Name:</strong> {key_name}</p><p><strong>Created:</strong> {created_at}</p><p style="margin-bottom:12px;margin-top:16px">Your new API key is available in your dashboard. For security reasons, we don''t include API keys in emails.</p><div style="text-align:center;margin:20px 0"><a href="{app_url}/dashboard" class="cta-button">üîê View API Key in Dashboard</a></div><p style="font-size:14px;color:#6b7280;margin-top:12px">‚ö†Ô∏è Keep this key secure and never share it publicly.</p></div><div style="text-align:center;margin:30px 0"><a href="{app_url}/dashboard" class="cta-button">üìä Manage API Keys</a></div><p>If you didn''t create this API key, please contact our support team immediately at <a href="mailto:support@gatewayz.ai" style="color:#3b82f6">support@gatewayz.ai</a>.</p></div><div class="footer"><p>¬© 2024 {app_name}. All rights reserved.</p></div></div></body></html>',
    'New API Key Created - {app_name}\n\nHi {username},\n\nA new API key has been created for your account.\n\nKey Name: {key_name}\nCreated: {created_at}\n\nYour new API key is available in your dashboard for security reasons.\n\nIf you didn''t create this API key, please contact our support team immediately at support@gatewayz.ai.\n\nBest regards,\nThe {app_name} Team',
    ARRAY['username', 'key_name', 'created_at', 'app_name', 'app_url']
)
ON CONFLICT (id) DO NOTHING;

-- Create password reset tokens table
CREATE TABLE IF NOT EXISTS password_reset_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for password reset tokens
CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_expires_at ON password_reset_tokens(expires_at);

-- Grant permissions
GRANT SELECT, INSERT, UPDATE, DELETE ON password_reset_tokens TO authenticated;

-- Add RLS policy for password reset tokens
ALTER TABLE password_reset_tokens ENABLE ROW LEVEL SECURITY;

-- Drop existing policy if it exists, then create new one
DROP POLICY IF EXISTS "Users can access their own password reset tokens" ON password_reset_tokens;
CREATE POLICY "Users can access their own password reset tokens" ON password_reset_tokens
    FOR ALL USING (user_id::text = auth.uid()::text);
